<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KNX Project Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    [x-cloak] { display: none !important; }
    .tab-active { @apply border-b-2 border-blue-600 text-blue-600; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="app()" x-cloak>

<!-- ===== UPLOAD PHASE ===== -->
<div x-show="phase === 'upload'" class="flex items-center justify-center min-h-screen">
  <div class="bg-white rounded-2xl shadow-lg p-10 w-full max-w-lg">
    <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">KNX Project Viewer</h1>

    <!-- Drop zone -->
    <div
      class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors"
      @dragover.prevent
      @drop.prevent="onDrop($event)"
      @click="$refs.fileInput.click()"
    >
      <svg class="mx-auto mb-3 w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
      </svg>
      <p class="text-gray-500" x-text="selectedFile ? selectedFile.name : 'KNXproj-Datei hier ablegen oder klicken'"></p>
      <input type="file" accept=".knxproj" class="hidden" x-ref="fileInput" @change="onFileChange($event)" />
    </div>

    <!-- Options -->
    <div class="mt-5 space-y-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Passwort (optional)</label>
        <input type="password" x-model="password" placeholder="Leer lassen wenn nicht geschÃ¼tzt"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </div>
    </div>

    <!-- Error -->
    <div x-show="error" class="mt-4 bg-red-50 border border-red-200 rounded-lg px-4 py-3 text-sm text-red-700" x-text="error"></div>

    <!-- Submit -->
    <button
      @click="parseProject()"
      :disabled="!selectedFile || loading"
      class="mt-6 w-full bg-blue-600 text-white font-semibold py-2.5 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
    >
      <svg x-show="loading" class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
      </svg>
      <span x-text="loading ? 'Wird geparstâ€¦' : 'Parsen'"></span>
    </button>
    <button @click="skipToMonitor()"
      class="mt-3 w-full text-sm text-gray-500 hover:text-blue-600 py-2 transition-colors">
      Ohne Projektdatei â†’ Nur Bus-Monitor
    </button>
  </div>
</div>

<!-- ===== RESULT PHASE ===== -->
<div x-show="phase === 'result'" class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-bold text-gray-800" x-text="projectName"></h1>
      <div class="flex items-center gap-4">
        <button @click="exportMarkdown()" class="text-sm text-gray-600 hover:text-gray-900">â†“ Markdown</button>
        <button @click="exportPDF()" class="text-sm text-gray-600 hover:text-gray-900">â†“ PDF</button>
        <button @click="reset()" class="text-sm text-blue-600 hover:underline">Neue Datei laden</button>
        <!-- Connection indicator -->
        <span class="flex items-center gap-1.5 text-sm border-l pl-4">
          <span class="w-2 h-2 rounded-full flex-shrink-0"
                :class="wsStatus === 'connected' ? 'bg-green-500' : 'bg-red-400'"></span>
          <span class="text-gray-600" x-text="wsStatus === 'connected' ? gatewayIP : 'Kein Gateway'"></span>
          <button @click="showGatewayConfig = true" class="text-gray-400 hover:text-gray-700 ml-0.5" title="Gateway konfigurieren">âš™</button>
        </span>
      </div>
    </div>

    <!-- Gateway Config Modal -->
    <div x-show="showGatewayConfig" x-cloak
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @keydown.escape.window="showGatewayConfig = false">
      <div class="bg-white rounded-xl p-6 w-80 shadow-2xl">
        <h3 class="text-base font-semibold text-gray-800 mb-4">KNX/IP Gateway</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">IP-Adresse</label>
            <input x-model="gatewayIP" placeholder="192.168.1.100" type="text"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
            <input x-model.number="gatewayPort" type="number" min="1" max="65535"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Sprache</label>
            <select x-model="gatewayLanguage"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
              <option value="de-DE">Deutsch (de-DE)</option>
              <option value="en-US">English (en-US)</option>
            </select>
          </div>
        </div>
        <p x-show="gatewayError" x-text="gatewayError" class="mt-2 text-sm text-red-600"></p>
        <div class="flex gap-2 mt-5">
          <button @click="saveGatewayConfig()"
                  class="flex-1 bg-blue-600 text-white text-sm font-semibold py-2 rounded-lg hover:bg-blue-700 transition-colors">Verbinden</button>
          <button @click="showGatewayConfig = false; gatewayError = ''"
                  class="flex-1 bg-gray-100 text-gray-700 text-sm font-semibold py-2 rounded-lg hover:bg-gray-200 transition-colors">Abbrechen</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
      <template x-for="tab in visibleTabs" :key="tab.id">
        <button
          @click="activeTab = tab.id"
          :class="activeTab === tab.id ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500 hover:text-gray-800'"
          class="px-4 py-2 text-sm font-medium whitespace-nowrap transition-colors"
          x-text="tab.label"
        ></button>
      </template>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 flex-1 w-full">

    <!-- INFO TAB -->
    <div x-show="activeTab === 'info'">
      <h2 class="text-lg font-semibold mb-4 text-gray-700">Projektinformationen</h2>
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <table class="w-full text-sm">
          <tbody>
            <template x-for="[key, val] in infoRows" :key="key">
              <tr class="border-t first:border-t-0 hover:bg-gray-50">
                <td class="px-4 py-3 font-medium text-gray-600 w-1/3" x-text="key"></td>
                <td class="px-4 py-3 text-gray-800" x-text="val ?? 'â€”'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- DEVICES TAB -->
    <div x-show="activeTab === 'devices'">

      <!-- Bus-only mode (no project) -->
      <div x-show="!project">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-700">GerÃ¤te aus Bus-Monitor
            (<span x-text="filteredBusDevices.length"></span>)
            <span class="text-xs font-normal text-gray-400 ml-2">â€” Klick auf Name/Beschreibung zum Bearbeiten</span>
          </h2>
          <input x-model="deviceSearch" type="search" placeholder="Suchenâ€¦"
            class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div class="bg-white rounded-xl shadow overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
              <tr>
                <th class="px-4 py-3 text-left">PA</th>
                <th class="px-4 py-3 text-left">Name âœŽ</th>
                <th class="px-4 py-3 text-left">Beschreibung âœŽ</th>
                <th class="px-4 py-3 text-left">Telegramme</th>
                <th class="px-4 py-3 text-left">Letztes Telegramm</th>
                <th class="px-4 py-3 text-left">Gesendete GAs</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="dev in filteredBusDevices" :key="dev.individual_address">
                <tr class="border-t hover:bg-gray-50">
                  <td class="px-4 py-3 font-mono text-xs font-semibold" x-text="dev.individual_address"></td>
                  <!-- Editable name -->
                  <td class="px-3 py-2 cursor-pointer hover:bg-yellow-50 min-w-[120px]"
                      @click="startEdit('devices', dev.individual_address, 'name', annotations.devices?.[dev.individual_address]?.name ?? '')">
                    <template x-if="editingKey !== 'devices|' + dev.individual_address + '|name'">
                      <span :class="dev.name ? 'font-medium text-gray-800' : 'text-gray-300 italic text-xs'"
                            x-text="dev.name || 'Nameâ€¦'"></span>
                    </template>
                    <template x-if="editingKey === 'devices|' + dev.individual_address + '|name'">
                      <input x-model="editValue" @blur="saveEdit()" @keydown.enter="saveEdit()"
                             @keydown.escape.prevent="editingKey=''" @click.stop
                             class="w-full border border-blue-400 rounded px-2 py-0.5 text-sm outline-none"
                             x-init="$nextTick(() => $el.focus())" />
                    </template>
                  </td>
                  <!-- Editable description -->
                  <td class="px-3 py-2 cursor-pointer hover:bg-yellow-50 min-w-[160px]"
                      @click="startEdit('devices', dev.individual_address, 'description', annotations.devices?.[dev.individual_address]?.description ?? '')">
                    <template x-if="editingKey !== 'devices|' + dev.individual_address + '|description'">
                      <span :class="dev.description ? 'text-gray-600' : 'text-gray-300 italic text-xs'"
                            x-text="dev.description || 'Beschreibungâ€¦'"></span>
                    </template>
                    <template x-if="editingKey === 'devices|' + dev.individual_address + '|description'">
                      <input x-model="editValue" @blur="saveEdit()" @keydown.enter="saveEdit()"
                             @keydown.escape.prevent="editingKey=''" @click.stop
                             class="w-full border border-blue-400 rounded px-2 py-0.5 text-sm outline-none"
                             x-init="$nextTick(() => $el.focus())" />
                    </template>
                  </td>
                  <td class="px-4 py-3 text-gray-500 text-center" x-text="dev.count"></td>
                  <td class="px-4 py-3 font-mono text-xs text-gray-400" x-text="dev.lastTs.split(' ')[1] ?? dev.lastTs"></td>
                  <td class="px-4 py-3">
                    <div class="flex flex-wrap gap-1">
                      <template x-for="ga in dev.gas" :key="ga">
                        <button @click="gaSearch = ga; activeTab = 'group_addresses'"
                          class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded font-mono hover:bg-blue-200"
                          x-text="ga"></button>
                      </template>
                    </div>
                  </td>
                </tr>
              </template>
              <tr x-show="filteredBusDevices.length === 0">
                <td colspan="6" class="text-center text-gray-400 py-10 text-sm">Warte auf Telegramme vom Busâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Project mode -->
      <div x-show="project">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-700">GerÃ¤te (<span x-text="filteredDevices.length"></span>)</h2>
        <input x-model="deviceSearch" type="search" placeholder="Suchenâ€¦"
          class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </div>
      <div class="bg-white rounded-xl shadow overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
            <tr>
              <th class="px-4 py-3 text-left">Adresse</th>
              <th class="px-4 py-3 text-left">Name</th>
              <th class="px-4 py-3 text-left">Hersteller</th>
              <th class="px-4 py-3 text-left">Bestellnr.</th>
              <th class="px-4 py-3 text-left">Applikation</th>
              <th class="px-4 py-3 text-left">KOs</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="dev in filteredDevices" :key="dev.individual_address">
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-3 font-mono text-xs" x-text="dev.individual_address"></td>
                <td class="px-4 py-3 font-medium" x-text="dev.name"></td>
                <td class="px-4 py-3 text-gray-600" x-text="dev.manufacturer_name"></td>
                <td class="px-4 py-3 text-gray-600" x-text="dev.order_number ?? 'â€”'"></td>
                <td class="px-4 py-3 text-gray-600 text-xs" x-text="dev.application ?? 'â€”'"></td>
                <td class="px-4 py-3">
                  <div class="flex items-center gap-2">
                    <button @click.stop="toggleDevice(dev.individual_address)"
                      class="text-gray-400 hover:text-gray-700 text-xs w-4 text-center"
                      x-text="expandedDevices.has(dev.individual_address) ? 'â–¾' : 'â–¸'">
                    </button>
                    <button @click.stop="navigateToDeviceCOs(dev.individual_address)"
                      class="text-blue-600 text-xs hover:underline"
                      x-text="(dev.communication_object_ids?.length ?? 0) + ' KOs'">
                    </button>
                  </div>
                </td>
              </tr>
              <!-- Expanded KOs -->
              <tr x-show="expandedDevices.has(dev.individual_address)" class="bg-blue-50">
                <td colspan="6" class="px-6 py-3">
                  <div x-show="deviceCOs(dev.individual_address).length === 0" class="text-gray-400 text-xs">Keine Kommunikationsobjekte</div>
                  <table class="w-full text-xs" x-show="deviceCOs(dev.individual_address).length > 0">
                    <thead class="text-gray-500">
                      <tr>
                        <th class="text-left pr-4 pb-1">Nr.</th>
                        <th class="text-left pr-4 pb-1">Name</th>
                        <th class="text-left pr-4 pb-1">DPT</th>
                        <th class="text-left pr-4 pb-1">Flags</th>
                        <th class="text-left pb-1">Gruppenadressen</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="co in deviceCOs(dev.individual_address)" :key="co._key">
                        <tr :data-co-key="co._key"
                          @click.stop="navigateToCO($el.dataset.coKey)"
                          title="Zu Kommunikationsobjekt springen"
                          class="border-t border-blue-100 hover:bg-blue-100 cursor-pointer">
                          <td class="pr-4 py-1 font-mono" x-text="co.number"></td>
                          <td class="pr-4 py-1" x-text="co.name"></td>
                          <td class="pr-4 py-1 font-mono" :title="dptTitle(co.dpts?.[0])" x-text="co.dpts?.[0] ? (co.dpts[0].main + (co.dpts[0].sub != null ? '.' + String(co.dpts[0].sub).padStart(3,'0') : '')) : 'â€”'"></td>
                          <td class="pr-4 py-1 font-mono" :title="flagTitle(co)" x-text="flagString(co)"></td>
                          <td class="py-1 text-blue-600 underline decoration-dotted" x-text="(co.group_address_links ?? []).join(', ') || 'â€”'"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      </div> <!-- end project mode -->
    </div>

    <!-- GROUP ADDRESSES TAB -->
    <div x-show="activeTab === 'group_addresses'">

      <!-- Bus-only mode (no project) -->
      <div x-show="!project">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-700">Gruppenadressen aus Bus-Monitor
            (<span x-text="filteredBusGAs.length"></span>)
            <span class="text-xs font-normal text-gray-400 ml-2">â€” Klick auf Name/Beschreibung zum Bearbeiten</span>
          </h2>
          <input x-model="gaSearch" type="search" placeholder="Suchenâ€¦"
            class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div class="bg-white rounded-xl shadow overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
              <tr>
                <th class="px-4 py-3 text-left">Adresse</th>
                <th class="px-4 py-3 text-left">Name âœŽ</th>
                <th class="px-4 py-3 text-left">Beschreibung âœŽ</th>
                <th class="px-4 py-3 text-left">Letzter Wert</th>
                <th class="px-4 py-3 text-left">Zeitstempel</th>
                <th class="px-4 py-3 text-left">Quell-PAs</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="ga in filteredBusGAs" :key="ga.address">
                <tr class="border-t hover:bg-gray-50">
                  <td class="px-4 py-3 font-mono text-xs font-semibold" x-text="ga.address"></td>
                  <!-- Editable name -->
                  <td class="px-3 py-2 cursor-pointer hover:bg-yellow-50 min-w-[120px]"
                      @click="startEdit('group_addresses', ga.address, 'name', annotations.group_addresses?.[ga.address]?.name ?? '')">
                    <template x-if="editingKey !== 'group_addresses|' + ga.address + '|name'">
                      <span :class="ga.name ? 'font-medium text-gray-800' : 'text-gray-300 italic text-xs'"
                            x-text="ga.name || 'Nameâ€¦'"></span>
                    </template>
                    <template x-if="editingKey === 'group_addresses|' + ga.address + '|name'">
                      <input x-model="editValue" @blur="saveEdit()" @keydown.enter="saveEdit()"
                             @keydown.escape.prevent="editingKey=''" @click.stop
                             class="w-full border border-blue-400 rounded px-2 py-0.5 text-sm outline-none"
                             x-init="$nextTick(() => $el.focus())" />
                    </template>
                  </td>
                  <!-- Editable description -->
                  <td class="px-3 py-2 cursor-pointer hover:bg-yellow-50 min-w-[160px]"
                      @click="startEdit('group_addresses', ga.address, 'description', annotations.group_addresses?.[ga.address]?.description ?? '')">
                    <template x-if="editingKey !== 'group_addresses|' + ga.address + '|description'">
                      <span :class="ga.description ? 'text-gray-600' : 'text-gray-300 italic text-xs'"
                            x-text="ga.description || 'Beschreibungâ€¦'"></span>
                    </template>
                    <template x-if="editingKey === 'group_addresses|' + ga.address + '|description'">
                      <input x-model="editValue" @blur="saveEdit()" @keydown.enter="saveEdit()"
                             @keydown.escape.prevent="editingKey=''" @click.stop
                             class="w-full border border-blue-400 rounded px-2 py-0.5 text-sm outline-none"
                             x-init="$nextTick(() => $el.focus())" />
                    </template>
                  </td>
                  <td class="px-4 py-3 font-mono text-sm font-semibold" x-text="ga.lastValue"></td>
                  <td class="px-4 py-3 font-mono text-xs text-gray-400" x-text="ga.lastTs.split(' ')[1] ?? ga.lastTs"></td>
                  <td class="px-4 py-3">
                    <div class="flex flex-wrap gap-1">
                      <template x-for="src in ga.srcs" :key="src">
                        <span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded font-mono" x-text="src"></span>
                      </template>
                    </div>
                  </td>
                </tr>
              </template>
              <tr x-show="filteredBusGAs.length === 0">
                <td colspan="6" class="text-center text-gray-400 py-10 text-sm">Warte auf Telegramme vom Busâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Project mode -->
      <div x-show="project">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-700">Gruppenadressen (<span x-text="filteredGAs.length"></span>)</h2>
        <input x-model="gaSearch" type="search" placeholder="Suchenâ€¦"
          class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </div>
      <div class="bg-white rounded-xl shadow overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
            <tr>
              <th class="px-4 py-3 text-left">Adresse</th>
              <th class="px-4 py-3 text-left">Name</th>
              <th class="px-4 py-3 text-left">DPT</th>
              <th class="px-4 py-3 text-left">Beschreibung</th>
              <th class="px-4 py-3 text-left">Letzter Wert</th>
              <th class="px-4 py-3 text-left">VerknÃ¼pfte KOs</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="ga in filteredGAs" :key="ga.address">
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-3 font-mono text-xs" x-text="ga.address"></td>
                <td class="px-4 py-3 font-medium" x-text="ga.name"></td>
                <td class="px-4 py-3 font-mono text-xs" :title="dptTitle(ga.dpt)" x-text="ga.dpt ? (ga.dpt.main + (ga.dpt.sub != null ? '.' + String(ga.dpt.sub).padStart(3,'0') : '')) : 'â€”'"></td>
                <td class="px-4 py-3 text-gray-600 text-xs" x-text="ga.description || 'â€”'"></td>
                <td class="px-4 py-3">
                  <template x-if="currentValues[ga.address]">
                    <span class="font-mono text-sm text-gray-800"
                          :title="currentValues[ga.address]?.ts"
                          x-text="currentValues[ga.address]?.value"></span>
                  </template>
                  <span x-show="!currentValues[ga.address]" class="text-gray-300 text-sm">â€”</span>
                </td>
                <td class="px-4 py-3">
                  <div class="flex flex-wrap gap-1">
                    <template x-for="coId in (ga.communication_object_ids ?? [])" :key="coId">
                      <button @click.stop="navigateToCO(coId)"
                        class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded hover:bg-blue-200 font-mono whitespace-nowrap"
                        x-text="(project?.communication_objects?.[coId]?.device_address ?? '') + ' #' + (project?.communication_objects?.[coId]?.number ?? '')">
                      </button>
                    </template>
                    <span x-show="(ga.communication_object_ids ?? []).length === 0" class="text-xs text-gray-400">â€”</span>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      </div> <!-- end project mode -->
    </div>

    <!-- TOPOLOGY TAB -->
    <div x-show="activeTab === 'topology'">
      <h2 class="text-lg font-semibold mb-4 text-gray-700">Topologie</h2>
      <div class="space-y-2">
        <template x-for="[areaId, area] in Object.entries(project?.topology ?? {})" :key="areaId">
          <div class="bg-white rounded-xl shadow overflow-hidden">
            <!-- Area header -->
            <button @click="toggleTopology('area_' + areaId)"
              class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-gray-50 font-semibold text-gray-700">
              <span class="text-gray-400" x-text="expandedTopology.has('area_' + areaId) ? 'â–¾' : 'â–¸'"></span>
              <span class="font-mono text-xs text-gray-400 w-8" x-text="areaId"></span>
              <span x-text="area.name"></span>
              <span class="ml-auto text-xs text-gray-400 font-normal" x-text="Object.keys(area.lines ?? {}).length + ' Linien'"></span>
            </button>
            <!-- Lines -->
            <div x-show="expandedTopology.has('area_' + areaId)" class="border-t">
              <template x-for="[lineId, line] in Object.entries(area.lines ?? {})" :key="lineId">
                <div>
                  <button @click="toggleTopology('line_' + areaId + '_' + lineId)"
                    class="w-full flex items-center gap-3 px-8 py-2.5 text-left hover:bg-gray-50 text-gray-600">
                    <span class="text-gray-400" x-text="expandedTopology.has('line_' + areaId + '_' + lineId) ? 'â–¾' : 'â–¸'"></span>
                    <span class="font-mono text-xs text-gray-400 w-12" x-text="areaId + '.' + lineId"></span>
                    <span x-text="line.name"></span>
                    <span class="ml-auto text-xs text-gray-400" x-text="(line.devices ?? []).length + ' GerÃ¤te'"></span>
                  </button>
                  <!-- Devices in line -->
                  <div x-show="expandedTopology.has('line_' + areaId + '_' + lineId)" class="border-t bg-gray-50">
                    <template x-for="devAddr in (line.devices ?? [])" :key="devAddr">
                      <div class="flex items-center gap-3 px-12 py-2 text-sm border-b last:border-b-0 hover:bg-white">
                        <span class="font-mono text-xs text-gray-400 w-16" x-text="devAddr"></span>
                        <span class="text-gray-700" x-text="project?.devices?.[devAddr]?.name ?? devAddr"></span>
                        <span class="ml-auto text-xs text-gray-400" x-text="project?.devices?.[devAddr]?.manufacturer_name ?? ''"></span>
                      </div>
                    </template>
                    <div x-show="(line.devices ?? []).length === 0" class="px-12 py-2 text-sm text-gray-400">Keine GerÃ¤te</div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
        <div x-show="Object.keys(project?.topology ?? {}).length === 0" class="text-gray-400 text-sm">Keine Topologiedaten</div>
      </div>
    </div>

    <!-- LOCATIONS TAB -->
    <div x-show="activeTab === 'locations'">
      <h2 class="text-lg font-semibold mb-4 text-gray-700">Standorte</h2>
      <div x-show="!project?.locations || Object.keys(project.locations).length === 0" class="text-gray-400 text-sm">Keine Standortdaten</div>
      <div class="space-y-2" x-show="project?.locations && Object.keys(project.locations).length > 0">
        <template x-for="[spaceId, space] in Object.entries(project?.locations ?? {})" :key="spaceId">
          <div x-data="{ open: false }" class="bg-white rounded-xl shadow overflow-hidden">
            <button @click="open = !open"
              class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-gray-50 font-semibold text-gray-700">
              <span class="text-gray-400" x-text="open ? 'â–¾' : 'â–¸'"></span>
              <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-normal" x-text="space.type ?? ''"></span>
              <span x-text="space.name"></span>
            </button>
            <div x-show="open" class="border-t">
              <div x-html="renderSpace(space, 1)"></div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- COMMUNICATION OBJECTS TAB -->
    <div x-show="activeTab === 'com_objects'">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-700">Kommunikationsobjekte (<span x-text="filteredCOs.length"></span>)</h2>
        <input x-model="coSearch" type="search" placeholder="Suchenâ€¦"
          class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </div>
      <div class="bg-white rounded-xl shadow overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
            <tr>
              <th class="px-4 py-3 text-left">KO-Nr.</th>
              <th class="px-4 py-3 text-left">Name</th>
              <th class="px-4 py-3 text-left">DPT</th>
              <th class="px-4 py-3 text-left">Flags</th>
              <th class="px-4 py-3 text-left">Gruppenadressen</th>
            </tr>
          </thead>
          <template x-for="group in cosByDevice" :key="group.addr">
            <tbody>
              <tr @click="toggleCODevice(group.addr)"
                class="bg-blue-50 border-t cursor-pointer hover:bg-blue-100 select-none">
                <td colspan="5" class="px-4 py-2.5 flex items-center gap-2">
                  <span class="text-gray-400 text-xs" x-text="(coSearch || expandedCODevices.has(group.addr)) ? 'â–¾' : 'â–¸'"></span>
                  <span class="font-mono text-xs text-gray-500" x-text="group.addr"></span>
                  <span class="font-semibold text-gray-700 text-sm" x-text="group.deviceName"></span>
                  <span class="ml-auto text-xs text-gray-400" x-text="group.cos.length + ' KOs'"></span>
                </td>
              </tr>
              <template x-for="co in group.cos" :key="co._key">
                <tr x-show="coSearch || expandedCODevices.has(group.addr)"
                  @click="navigateToGA(co)"
                  :title="'Zu Gruppenadresse springen: ' + (co.group_address_links ?? []).join(', ')"
                  :class="co._key === highlightedCO ? 'border-t bg-yellow-100 ring-1 ring-yellow-400' : 'border-t hover:bg-blue-50 cursor-pointer'">
                  <td class="px-4 py-3 font-mono text-xs" x-text="co.number"></td>
                  <td class="px-4 py-3" x-text="co.name"></td>
                  <td class="px-4 py-3 font-mono text-xs" :title="dptTitle(co.dpts?.[0])" x-text="co.dpts?.[0] ? (co.dpts[0].main + (co.dpts[0].sub != null ? '.' + String(co.dpts[0].sub).padStart(3,'0') : '')) : 'â€”'"></td>
                  <td class="px-4 py-3 font-mono text-xs" :title="flagTitle(co)" x-text="flagString(co)"></td>
                  <td class="px-4 py-3 text-xs text-blue-600 underline decoration-dotted" x-text="(co.group_address_links ?? []).join(', ') || 'â€”'"></td>
                </tr>
              </template>
            </tbody>
          </template>
        </table>
      </div>
    </div>

    <!-- FUNCTIONS TAB -->
    <div x-show="activeTab === 'functions'">
      <h2 class="text-lg font-semibold mb-4 text-gray-700">Funktionen</h2>
      <div x-show="!project?.functions || Object.keys(project.functions).length === 0" class="text-gray-400 text-sm">Keine Funktionen vorhanden</div>
      <div class="space-y-3" x-show="project?.functions && Object.keys(project.functions).length > 0">
        <template x-for="[fnId, fn] in Object.entries(project?.functions ?? {})" :key="fnId">
          <div class="bg-white rounded-xl shadow p-4">
            <div class="font-semibold text-gray-700 mb-2" x-text="fn.name"></div>
            <div class="text-xs text-gray-400 mb-2" x-text="'Typ: ' + (fn.function_type ?? 'â€”')"></div>
            <div x-show="fn.group_addresses && Object.keys(fn.group_addresses).length > 0" class="flex flex-wrap gap-1">
              <template x-for="gaRef in Object.values(fn.group_addresses ?? {})" :key="gaRef.address">
                <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded font-mono" x-text="gaRef.address + (gaRef.name ? ' ' + gaRef.name : '')"></span>
              </template>
            </div>
            <div x-show="!fn.group_addresses || Object.keys(fn.group_addresses).length === 0" class="text-xs text-gray-400">Keine Gruppenadressen</div>
          </div>
        </template>
      </div>
    </div>

    <!-- BUS MONITOR TAB -->
    <div x-show="activeTab === 'bus_monitor'">
      <div class="flex items-center gap-3 mb-4 flex-wrap">
        <h2 class="text-lg font-semibold text-gray-700 mr-2">Bus-Monitor</h2>
        <input x-model="liveLogFilter" type="search" placeholder="Filter (GA, GerÃ¤t, Wert, PA)â€¦"
               class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        <button @click="liveLogPaused = !liveLogPaused"
                :class="liveLogPaused ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 'bg-white border-gray-300 text-gray-600'"
                class="border rounded-lg px-3 py-1.5 text-sm hover:opacity-80 transition-colors"
                x-text="liveLogPaused ? 'â–¶ Fortsetzen' : 'â¸ Pausieren'"></button>
        <button @click="liveLog = []"
                class="bg-white border border-gray-300 rounded-lg px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-50 transition-colors">ðŸ—‘ Leeren</button>
        <span class="text-gray-400 text-sm ml-auto" x-text="filteredLiveLog.length + ' / ' + liveLog.length + ' EintrÃ¤ge'"></span>
        <span class="flex items-center gap-1.5 text-sm">
          <span class="w-2 h-2 rounded-full flex-shrink-0"
                :class="wsStatus === 'connected' ? 'bg-green-500' : 'bg-red-400'"></span>
          <span class="text-gray-500" x-text="wsStatus === 'connected' ? ('Verbunden: ' + gatewayIP) : 'Kein Gateway'"></span>
        </span>
      </div>

      <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="overflow-auto max-h-[60vh]">
          <table class="w-full text-sm font-mono">
            <thead class="sticky top-0 bg-gray-50 text-gray-500 uppercase text-xs z-10">
              <tr>
                <th class="px-3 py-3 text-left whitespace-nowrap">Zeit</th>
                <th class="px-3 py-3 text-left">PA</th>
                <th class="px-3 py-3 text-left">GerÃ¤t</th>
                <th class="px-3 py-3 text-left">GA</th>
                <th class="px-3 py-3 text-left">GA-Name</th>
                <th class="px-3 py-3 text-left">Wert</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(entry, i) in filteredLiveLog" :key="i">
                <tr class="border-t hover:bg-gray-50 transition-colors">
                  <td class="px-3 py-2 text-gray-400 whitespace-nowrap text-xs" x-text="entry.ts.split(' ')[1]"></td>
                  <td class="px-3 py-2 text-gray-600 text-xs" x-text="entry.src"></td>
                  <td class="px-3 py-2 text-gray-600 text-xs max-w-[140px] truncate" x-text="entry.device" :title="entry.device"></td>
                  <td class="px-3 py-2 text-blue-600 cursor-pointer hover:underline text-xs"
                      x-text="entry.ga"
                      @click="gaSearch = entry.ga; activeTab = 'group_addresses'"></td>
                  <td class="px-3 py-2 text-gray-700 text-xs max-w-[180px] truncate" x-text="entry.ga_name" :title="entry.ga_name"></td>
                  <td class="px-3 py-2 font-semibold text-gray-900 text-xs" x-text="entry.value"></td>
                </tr>
              </template>
              <tr x-show="filteredLiveLog.length === 0">
                <td colspan="6" class="text-center text-gray-400 py-12 font-sans">
                  <span x-text="wsStatus === 'connected' ? 'Warte auf Telegrammeâ€¦' : 'Kein Gateway verbunden. âš™-Button zum Konfigurieren.'"></span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
function app() {
  return {
    phase: 'upload',
    loading: false,
    error: '',
    selectedFile: null,
    password: '',
    language: '',
    project: null,
    activeTab: 'info',
    tabs: [
      { id: 'info', label: 'Info' },
      { id: 'devices', label: 'GerÃ¤te' },
      { id: 'group_addresses', label: 'Gruppenadressen' },
      { id: 'topology', label: 'Topologie' },
      { id: 'locations', label: 'Standorte' },
      { id: 'com_objects', label: 'Kommunikationsobjekte' },
      { id: 'functions', label: 'Funktionen' },
      { id: 'bus_monitor', label: 'Bus-Monitor' },
    ],
    deviceSearch: '',
    gaSearch: '',
    coSearch: '',
    expandedDevices: new Set(),
    expandedTopology: new Set(),
    expandedCODevices: new Set(),
    highlightedCO: null,

    // WebSocket & Live-Monitor state
    ws: null,
    wsStatus: 'disconnected',
    gatewayIP: '',
    gatewayPort: 3671,
    gatewayLanguage: 'de-DE',
    gatewayError: '',
    showGatewayConfig: false,
    currentValues: {},
    liveLog: [],
    liveLogFilter: '',
    liveLogPaused: false,

    // Annotations (editable device/GA metadata)
    annotations: { devices: {}, group_addresses: {} },
    editingKey: '',
    editValue: '',

    init() {
      this.connectWebSocket();
      this.loadAnnotations();
    },

    async loadAnnotations() {
      try {
        const res = await fetch('/api/annotations');
        if (res.ok) this.annotations = await res.json();
      } catch (_) {}
    },

    startEdit(type, key, field, current) {
      this.editingKey = `${type}|${key}|${field}`;
      this.editValue = current;
    },

    async saveEdit() {
      if (!this.editingKey) return;
      const parts = this.editingKey.split('|');
      const type = parts[0];
      const field = parts[parts.length - 1];
      const key = parts.slice(1, -1).join('|');
      this.editingKey = '';
      if (!this.annotations[type]) this.annotations[type] = {};
      if (!this.annotations[type][key]) this.annotations[type][key] = {};
      this.annotations[type][key][field] = this.editValue;
      this.annotations = { ...this.annotations };  // trigger reactivity
      await fetch('/api/annotations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.annotations),
      });
    },

    get busDevices() {
      const map = {};
      for (const e of this.liveLog) {
        if (!map[e.src]) map[e.src] = { individual_address: e.src, busName: e.device || '', count: 0, lastTs: e.ts, gas: [] };
        const d = map[e.src];
        d.count++;
        if (e.ts > d.lastTs) d.lastTs = e.ts;
        if (e.ga && !d.gas.includes(e.ga)) d.gas.push(e.ga);
        if (!d.busName && e.device) d.busName = e.device;
      }
      return Object.values(map)
        .map(d => ({ ...d, gas: d.gas.sort(),
          name: this.annotations.devices?.[d.individual_address]?.name ?? d.busName ?? '',
          description: this.annotations.devices?.[d.individual_address]?.description ?? '' }))
        .sort((a, b) => a.individual_address.localeCompare(b.individual_address));
    },

    get filteredBusDevices() {
      const q = this.deviceSearch.toLowerCase();
      if (!q) return this.busDevices;
      return this.busDevices.filter(d =>
        d.individual_address.includes(q) || d.name.toLowerCase().includes(q) ||
        (d.description || '').toLowerCase().includes(q));
    },

    get busGAs() {
      const map = {};
      for (const e of this.liveLog) {  // newest first â€” first occurrence = latest value
        if (!map[e.ga]) map[e.ga] = { address: e.ga, busName: e.ga_name || '', lastValue: e.value, lastTs: e.ts, srcs: [] };
        const g = map[e.ga];
        if (!g.srcs.includes(e.src)) g.srcs.push(e.src);
        if (!g.busName && e.ga_name) g.busName = e.ga_name;
      }
      return Object.values(map)
        .map(g => ({ ...g, srcs: g.srcs.sort(),
          name: this.annotations.group_addresses?.[g.address]?.name ?? g.busName ?? '',
          description: this.annotations.group_addresses?.[g.address]?.description ?? '' }))
        .sort((a, b) => a.address.localeCompare(b.address));
    },

    get filteredBusGAs() {
      const q = this.gaSearch.toLowerCase();
      if (!q) return this.busGAs;
      return this.busGAs.filter(g =>
        g.address.includes(q) || g.name.toLowerCase().includes(q) ||
        (g.description || '').toLowerCase().includes(q));
    },

    connectWebSocket() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${protocol}//${location.host}/ws`);
      this.ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'status') {
          this.wsStatus = msg.connected ? 'connected' : 'disconnected';
          this.gatewayIP = msg.ip || '';
          this.gatewayPort = msg.port || 3671;
          this.gatewayLanguage = msg.language || 'de-DE';
        } else if (msg.type === 'snapshot') {
          this.currentValues = msg.values;
        } else if (msg.type === 'history') {
          this.liveLog = msg.entries;  // replaces entire log (newest first)
        } else if (msg.type === 'telegram') {
          this.currentValues[msg.ga] = { value: msg.value, ts: msg.ts };
          if (!this.liveLogPaused) {
            this.liveLog = [msg, ...this.liveLog].slice(0, 1000);
          }
        }
      };
      this.ws.onclose = () => {
        this.wsStatus = 'disconnected';
        setTimeout(() => this.connectWebSocket(), 3000);
      };
      this.ws.onerror = () => { this.wsStatus = 'error'; };
    },

    skipToMonitor() {
      this.phase = 'result';
      this.activeTab = 'bus_monitor';
    },

    async saveGatewayConfig() {
      this.gatewayError = '';
      try {
        const res = await fetch('/api/gateway', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip: this.gatewayIP, port: this.gatewayPort, language: this.gatewayLanguage }),
        });
        if (res.ok) this.showGatewayConfig = false;
        else this.gatewayError = 'Fehler beim Speichern';
      } catch (e) {
        this.gatewayError = 'Netzwerkfehler: ' + e.message;
      }
    },

    get visibleTabs() {
      return this.tabs.filter(tab => {
        if (tab.id === 'functions') return this.project && Object.keys(this.project.functions ?? {}).length > 0;
        return true;
      });
    },

    get filteredLiveLog() {
      if (!this.liveLogFilter) return this.liveLog;
      const f = this.liveLogFilter.toLowerCase();
      return this.liveLog.filter(e =>
        e.ga.includes(f) || (e.ga_name || '').toLowerCase().includes(f) ||
        (e.device || '').toLowerCase().includes(f) || (e.value || '').toLowerCase().includes(f) ||
        e.src.includes(f)
      );
    },

    onFileChange(event) {
      const file = event.target.files[0];
      if (file) this.selectedFile = file;
    },

    onDrop(event) {
      const file = event.dataTransfer.files[0];
      if (file) this.selectedFile = file;
    },

    async parseProject() {
      if (!this.selectedFile) return;
      this.loading = true;
      this.error = '';
      const form = new FormData();
      form.append('file', this.selectedFile);
      form.append('password', this.password);
      form.append('language', this.gatewayLanguage);
      try {
        const res = await fetch('/api/parse', { method: 'POST', body: form });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ detail: res.statusText }));
          this.error = err.detail ?? 'Unbekannter Fehler';
          return;
        }
        this.project = await res.json();
        this.phase = 'result';
      } catch (e) {
        this.error = 'Netzwerkfehler: ' + e.message;
      } finally {
        this.loading = false;
      }
    },

    reset() {
      this.phase = 'upload';
      this.project = null;
      this.selectedFile = null;
      this.error = '';
      this.expandedDevices = new Set();
      this.expandedTopology = new Set();
      this.expandedCODevices = new Set();
      this.highlightedCO = null;
      this.deviceSearch = '';
      this.gaSearch = '';
      this.coSearch = '';
    },

    _mdEsc(s) {
      return String(s ?? '').replace(/\|/g, '\\|').replace(/[\r\n]+/g, ' ');
    },

    _dptStr(dpt) {
      if (!dpt) return 'â€”';
      return dpt.sub != null ? `${dpt.main}.${String(dpt.sub).padStart(3,'0')}` : String(dpt.main);
    },

    _download(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    },

    exportMarkdown() {
      if (!this.project) { this._exportBusMarkdown(); return; }
      const e = s => this._mdEsc(s);
      const d = dpt => this._dptStr(dpt);
      const lines = [];

      lines.push(`# ${e(this.projectName)}`, '');

      lines.push('## Projektinformationen', '');
      for (const [key, val] of this.infoRows) lines.push(`- **${e(key)}:** ${e(val)}`);
      lines.push('');

      lines.push('## GerÃ¤te', '');
      lines.push('| Adresse | Name | Hersteller | Bestellnr. | Applikation |');
      lines.push('|---------|------|------------|------------|-------------|');
      for (const dev of this.allDevices)
        lines.push(`| ${e(dev.individual_address)} | ${e(dev.name)} | ${e(dev.manufacturer_name)} | ${e(dev.order_number)} | ${e(dev.application)} |`);
      lines.push('');

      lines.push('## Gruppenadressen', '');
      lines.push('| Adresse | Name | DPT | Beschreibung | VerknÃ¼pfte KOs |');
      lines.push('|---------|------|-----|--------------|----------------|');
      for (const ga of this.allGAs) {
        const cos = (ga.communication_object_ids ?? []).map(id => {
          const co = this.project?.communication_objects?.[id];
          return co ? `${co.device_address} #${co.number}` : null;
        }).filter(Boolean).join(', ');
        lines.push(`| ${e(ga.address)} | ${e(ga.name)} | ${e(d(ga.dpt))} | ${e(ga.description)} | ${e(cos || 'â€”')} |`);
      }
      lines.push('');

      lines.push('## Kommunikationsobjekte', '');
      for (const group of this.cosByDevice) {
        lines.push(`### ${e(group.addr)} â€“ ${e(group.deviceName)}`, '');
        lines.push('| KO-Nr. | Name | DPT | Flags | Gruppenadressen |');
        lines.push('|--------|------|-----|-------|-----------------|');
        for (const co of group.cos)
          lines.push(`| ${co.number} | ${e(co.name)} | ${e(d(co.dpts?.[0]))} | ${e(this.flagString(co))} | ${e((co.group_address_links ?? []).join(', ') || 'â€”')} |`);
        lines.push('');
      }

      lines.push('## Topologie', '');
      for (const [areaId, area] of Object.entries(this.project?.topology ?? {})) {
        lines.push(`### Bereich ${e(areaId)} â€“ ${e(area.name)}`, '');
        for (const [lineId, line] of Object.entries(area.lines ?? {})) {
          lines.push(`#### Linie ${e(areaId)}.${e(lineId)} â€“ ${e(line.name)}`, '');
          for (const addr of (line.devices ?? [])) {
            const dev = this.project?.devices?.[addr];
            lines.push(`- \`${e(addr)}\` ${e(dev?.name ?? '')}`);
          }
          lines.push('');
        }
      }

      const fns = Object.values(this.project?.functions ?? {});
      if (fns.length) {
        lines.push('## Funktionen', '');
        lines.push('| Name | Typ | Gruppenadressen |');
        lines.push('|------|-----|-----------------|');
        for (const fn of fns) {
          const gas = Object.values(fn.group_addresses ?? {}).map(r => r.address).join(', ');
          lines.push(`| ${e(fn.name)} | ${e(fn.function_type)} | ${e(gas || 'â€”')} |`);
        }
        lines.push('');
      }

      const safe = this.projectName.replace(/[^a-zA-Z0-9_\-]/g, '_');
      this._download(lines.join('\n'), `${safe}.md`, 'text/markdown;charset=utf-8');
    },

    _exportBusMarkdown() {
      const e = s => this._mdEsc(s);
      const lines = [
        '# KNX Bus-Dokumentation',
        `*Erstellt: ${new Date().toLocaleString('de-DE')}*`, '',
        '## GerÃ¤te', '',
        '| PA | Name | Beschreibung | Telegramme | Letztes Telegramm | GAs |',
        '|----|------|--------------|:----------:|-------------------|-----|',
      ];
      for (const d of this.busDevices)
        lines.push(`| ${e(d.individual_address)} | ${e(d.name)} | ${e(d.description)} | ${d.count} | ${e(d.lastTs)} | ${e(d.gas.join(', '))} |`);
      lines.push('', '## Gruppenadressen', '',
        '| Adresse | Name | Beschreibung | Letzter Wert | Zeitstempel | Quell-PAs |',
        '|---------|------|--------------|--------------|-------------|-----------|');
      for (const g of this.busGAs)
        lines.push(`| ${e(g.address)} | ${e(g.name)} | ${e(g.description)} | ${e(g.lastValue)} | ${e(g.lastTs)} | ${e(g.srcs.join(', '))} |`);
      lines.push('');
      this._download(lines.join('\n'), 'knx_bus_dokumentation.md', 'text/markdown;charset=utf-8');
    },

    exportPDF() {
      if (!this.project) { this._exportBusPDF(); return; }
      const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const d = dpt => this._dptStr(dpt);

      const css = `
        body{font-family:Arial,sans-serif;font-size:9pt;color:#1f2937;margin:15mm}
        h1{font-size:16pt;border-bottom:2px solid #2563eb;padding-bottom:4px;margin-bottom:12px}
        h2{font-size:12pt;color:#1d4ed8;margin-top:20px;border-bottom:1px solid #d1d5db;page-break-after:avoid}
        h3{font-size:10pt;color:#374151;margin:10px 0 4px}
        table{width:100%;border-collapse:collapse;margin:6px 0;font-size:8pt}
        th{background:#f3f4f6;text-align:left;padding:4px 6px;border:1px solid #d1d5db;font-weight:600}
        td{padding:3px 6px;border:1px solid #d1d5db;vertical-align:top}
        tr:nth-child(even) td{background:#f9fafb}
        .dh td{background:#dbeafe;font-weight:600}
        .mono{font-family:monospace}
        dl{display:grid;grid-template-columns:max-content 1fr;gap:2px 16px;margin:6px 0}
        dt{font-weight:600;color:#6b7280}
        @media print{h2{page-break-before:auto}}`;

      let html = `<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8">
        <title>${esc(this.projectName)}</title><style>${css}</style></head><body>
        <h1>${esc(this.projectName)}</h1>`;

      // Info
      html += '<h2>Projektinformationen</h2><dl>';
      for (const [key, val] of this.infoRows)
        html += `<dt>${esc(key)}</dt><dd>${esc(val)}</dd>`;
      html += '</dl>';

      // Devices
      html += '<h2>GerÃ¤te</h2><table><thead><tr><th>Adresse</th><th>Name</th><th>Hersteller</th><th>Bestellnr.</th><th>Applikation</th></tr></thead><tbody>';
      for (const dev of this.allDevices)
        html += `<tr><td class="mono">${esc(dev.individual_address)}</td><td>${esc(dev.name)}</td><td>${esc(dev.manufacturer_name)}</td><td>${esc(dev.order_number)}</td><td>${esc(dev.application)}</td></tr>`;
      html += '</tbody></table>';

      // Group addresses
      html += '<h2>Gruppenadressen</h2><table><thead><tr><th>Adresse</th><th>Name</th><th>DPT</th><th>Beschreibung</th><th>VerknÃ¼pfte KOs</th></tr></thead><tbody>';
      for (const ga of this.allGAs) {
        const cos = (ga.communication_object_ids ?? []).map(id => {
          const co = this.project?.communication_objects?.[id];
          return co ? `${co.device_address} #${co.number}` : null;
        }).filter(Boolean).join(', ');
        html += `<tr><td class="mono">${esc(ga.address)}</td><td>${esc(ga.name)}</td><td class="mono">${esc(d(ga.dpt))}</td><td>${esc(ga.description)}</td><td class="mono">${esc(cos||'â€”')}</td></tr>`;
      }
      html += '</tbody></table>';

      // Communication objects
      html += '<h2>Kommunikationsobjekte</h2><table><thead><tr><th>KO-Nr.</th><th>Name</th><th>DPT</th><th>Flags</th><th>Gruppenadressen</th></tr></thead><tbody>';
      for (const group of this.cosByDevice) {
        html += `<tr class="dh"><td colspan="5">${esc(group.addr)} â€“ ${esc(group.deviceName)}</td></tr>`;
        for (const co of group.cos)
          html += `<tr><td class="mono">${esc(co.number)}</td><td>${esc(co.name)}</td><td class="mono">${esc(d(co.dpts?.[0]))}</td><td class="mono">${esc(this.flagString(co))}</td><td class="mono">${esc((co.group_address_links??[]).join(', ')||'â€”')}</td></tr>`;
      }
      html += '</tbody></table>';

      // Topology
      html += '<h2>Topologie</h2><table><thead><tr><th>Bereich</th><th>Linie</th><th>Adresse</th><th>Name</th><th>Hersteller</th></tr></thead><tbody>';
      for (const [areaId, area] of Object.entries(this.project?.topology ?? {})) {
        for (const [lineId, line] of Object.entries(area.lines ?? {})) {
          for (const addr of (line.devices ?? [])) {
            const dev = this.project?.devices?.[addr];
            html += `<tr><td>${esc(areaId)} â€“ ${esc(area.name)}</td><td>${esc(areaId)}.${esc(lineId)} â€“ ${esc(line.name)}</td><td class="mono">${esc(addr)}</td><td>${esc(dev?.name??'')}</td><td>${esc(dev?.manufacturer_name??'')}</td></tr>`;
          }
        }
      }
      html += '</tbody></table>';

      // Functions
      const fns = Object.values(this.project?.functions ?? {});
      if (fns.length) {
        html += '<h2>Funktionen</h2><table><thead><tr><th>Name</th><th>Typ</th><th>Gruppenadressen</th></tr></thead><tbody>';
        for (const fn of fns) {
          const gas = Object.values(fn.group_addresses ?? {}).map(r => r.address).join(', ');
          html += `<tr><td>${esc(fn.name)}</td><td>${esc(fn.function_type)}</td><td class="mono">${esc(gas||'â€”')}</td></tr>`;
        }
        html += '</tbody></table>';
      }

      html += '</body></html>';
      const win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
      win.focus();
      setTimeout(() => win.print(), 500);
    },

    get projectName() {
      return this.project?.info?.name ?? this.selectedFile?.name ?? 'KNX Projekt';
    },

    _exportBusPDF() {
      const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const css = `
        body{font-family:Arial,sans-serif;font-size:9pt;color:#1f2937;margin:15mm}
        h1{font-size:16pt;border-bottom:2px solid #2563eb;padding-bottom:4px;margin-bottom:12px}
        h2{font-size:12pt;color:#1d4ed8;margin-top:20px;border-bottom:1px solid #d1d5db;page-break-after:avoid}
        table{width:100%;border-collapse:collapse;margin:6px 0;font-size:8pt}
        th{background:#f3f4f6;text-align:left;padding:4px 6px;border:1px solid #d1d5db;font-weight:600}
        td{padding:3px 6px;border:1px solid #d1d5db;vertical-align:top}
        tr:nth-child(even) td{background:#f9fafb}
        .mono{font-family:monospace}
        @media print{h2{page-break-before:auto}}`;
      let html = `<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8">
        <title>KNX Bus-Dokumentation</title><style>${css}</style></head><body>
        <h1>KNX Bus-Dokumentation</h1>
        <p style="color:#6b7280;font-size:8pt">Erstellt: ${new Date().toLocaleString('de-DE')}</p>`;
      html += '<h2>GerÃ¤te</h2><table><thead><tr><th>PA</th><th>Name</th><th>Beschreibung</th><th>Telegramme</th><th>Letztes Telegramm</th><th>GAs</th></tr></thead><tbody>';
      for (const d of this.busDevices)
        html += `<tr><td class="mono">${esc(d.individual_address)}</td><td>${esc(d.name)}</td><td>${esc(d.description)}</td><td style="text-align:center">${d.count}</td><td class="mono">${esc(d.lastTs)}</td><td class="mono">${esc(d.gas.join(', '))}</td></tr>`;
      html += '</tbody></table>';
      html += '<h2>Gruppenadressen</h2><table><thead><tr><th>Adresse</th><th>Name</th><th>Beschreibung</th><th>Letzter Wert</th><th>Zeitstempel</th><th>Quell-PAs</th></tr></thead><tbody>';
      for (const g of this.busGAs)
        html += `<tr><td class="mono">${esc(g.address)}</td><td>${esc(g.name)}</td><td>${esc(g.description)}</td><td class="mono">${esc(g.lastValue)}</td><td class="mono">${esc(g.lastTs)}</td><td class="mono">${esc(g.srcs.join(', '))}</td></tr>`;
      html += '</tbody></table></body></html>';
      const win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
      win.focus();
      setTimeout(() => win.print(), 500);
    },

    get infoRows() {
      if (!this.project?.info) return [];
      const info = this.project.info;
      return [
        ['Projektname', info.name],
        ['ETS-Version', info.tool_version],
        ['Gruppenadress-Stil', info.group_address_style],
        ['Zuletzt geÃ¤ndert', info.last_modified],
        ['Erstellt mit', info.created_by],
        ['Sprache', info.language_code],
        ['xknxproject Version', info.xknxproject_version],
      ].filter(([, v]) => v !== undefined && v !== null && v !== '');
    },

    get allDevices() {
      return Object.values(this.project?.devices ?? {});
    },

    get filteredDevices() {
      const q = this.deviceSearch.toLowerCase();
      if (!q) return this.allDevices;
      return this.allDevices.filter(d =>
        (d.name ?? '').toLowerCase().includes(q) ||
        (d.individual_address ?? '').toLowerCase().includes(q) ||
        (d.manufacturer_name ?? '').toLowerCase().includes(q) ||
        (d.order_number ?? '').toLowerCase().includes(q) ||
        (d.application ?? '').toLowerCase().includes(q)
      );
    },

    get allGAs() {
      return Object.values(this.project?.group_addresses ?? {});
    },

    get filteredGAs() {
      const q = this.gaSearch.toLowerCase();
      if (!q) return this.allGAs;
      return this.allGAs.filter(ga =>
        (ga.name ?? '').toLowerCase().includes(q) ||
        (ga.address ?? '').toLowerCase().includes(q) ||
        (ga.description ?? '').toLowerCase().includes(q)
      );
    },

    get allCOs() {
      return Object.entries(this.project?.communication_objects ?? {}).map(([key, co]) => ({
        ...co,
        _key: key,
        _device: co.device_address,
      }));
    },

    get filteredCOs() {
      const q = this.coSearch.toLowerCase();
      if (!q) return this.allCOs;
      return this.allCOs.filter(co =>
        (co.name ?? '').toLowerCase().includes(q) ||
        (co._device ?? '').toLowerCase().includes(q) ||
        String(co.number ?? '').includes(q) ||
        (co.group_address_links ?? []).some(ga => ga.toLowerCase().includes(q))
      );
    },

    toggleDevice(addr) {
      if (this.expandedDevices.has(addr)) {
        this.expandedDevices.delete(addr);
      } else {
        this.expandedDevices.add(addr);
      }
      this.expandedDevices = new Set(this.expandedDevices);
    },

    toggleTopology(key) {
      if (this.expandedTopology.has(key)) {
        this.expandedTopology.delete(key);
      } else {
        this.expandedTopology.add(key);
      }
      this.expandedTopology = new Set(this.expandedTopology);
    },

    navigateToDeviceCOs(addr) {
      this.coSearch = '';
      this.highlightedCO = null;
      this.expandedCODevices = new Set([...this.expandedCODevices, addr]);
      this.activeTab = 'com_objects';
    },

    navigateToCO(coId) {
      const co = this.project?.communication_objects?.[coId];
      if (!co) return;
      this.coSearch = '';
      this.highlightedCO = coId;
      this.expandedCODevices = new Set([...this.expandedCODevices, co.device_address]);
      this.activeTab = 'com_objects';
    },

    navigateToGA(co) {
      const links = co.group_address_links ?? [];
      if (links.length === 0) return;
      this.gaSearch = links[0];
      this.activeTab = 'group_addresses';
    },

    toggleCODevice(addr) {
      if (this.expandedCODevices.has(addr)) {
        this.expandedCODevices.delete(addr);
      } else {
        this.expandedCODevices.add(addr);
      }
      this.expandedCODevices = new Set(this.expandedCODevices);
    },

    dptTitle(dpt) {
      if (!dpt) return '';
      const names = {
        '1':'1-Bit Boolean','1.001':'Schalten (Aus/Ein)','1.002':'Boolean','1.003':'Freigabe',
        '1.004':'Rampe','1.005':'Alarm','1.006':'BinÃ¤rwert','1.007':'Schritt',
        '1.008':'Auf/Ab','1.009':'Ã–ffnen/SchlieÃŸen','1.010':'Fehler','1.011':'Zustand',
        '2':'2-Bit Zwangssteuerung','2.001':'Schalten (zwangsgesteuert)','2.002':'Boolean (zwangsgesteuert)',
        '3':'4-Bit Dimmen/Jalousie','3.007':'LichtstÃ¤rke dimmen','3.008':'Jalousie fahren',
        '4':'8-Bit Zeichen','4.001':'ASCII','4.002':'ISO 8859-1',
        '5':'8-Bit Unsigned','5.001':'Prozentwert (0â€“100 %)','5.003':'Winkel (0â€“360Â°)',
        '5.004':'Prozentwert (0â€“255)','5.005':'Dezimalwert (0â€“255)','5.010':'PulszÃ¤hler',
        '6':'8-Bit Signed','6.001':'Prozentwert (âˆ’128â€“127 %)','6.010':'PulszÃ¤hler',
        '7':'2-Byte Unsigned','7.001':'PulszÃ¤hler','7.002':'Zeitraum (ms)',
        '7.003':'Zeitraum (10 ms)','7.004':'Zeitraum (100 ms)','7.005':'Zeitraum (s)',
        '7.006':'Zeitraum (min)','7.007':'Zeitraum (h)','7.011':'LÃ¤nge (mm)','7.012':'Strom (mA)',
        '8':'2-Byte Signed','8.001':'Pulsdifferenz','8.002':'Zeitraum (10 ms)',
        '9':'2-Byte Float','9.001':'Temperatur (Â°C)','9.002':'Temperaturdifferenz (K)',
        '9.003':'Kelvin/Stunde','9.004':'BeleuchtungsstÃ¤rke (Lux)','9.005':'Windgeschwindigkeit (m/s)',
        '9.006':'Druck (Pa)','9.007':'Luftfeuchtigkeit (%)','9.008':'LuftqualitÃ¤t (ppm)',
        '9.009':'Zeitraum (s)','9.010':'Zeitraum (ms)','9.011':'Spannung (mV)',
        '9.020':'Spannung (mV)','9.021':'Strom (mA)','9.022':'Leistungsdichte (W/mÂ²)',
        '9.024':'Leistung (kW)','9.025':'Volumenfluss (l/h)','9.026':'Liter',
        '10':'Uhrzeit (3 Byte)','10.001':'Uhrzeit mit Wochentag',
        '11':'Datum (3 Byte)','11.001':'Datum',
        '12':'4-Byte Unsigned','12.001':'PulszÃ¤hler',
        '13':'4-Byte Signed','13.001':'PulszÃ¤hler','13.010':'Pulsdifferenz',
        '13.013':'Durchfluss (l/h)',
        '14':'4-Byte Float','14.007':'Winkel (Â°)','14.019':'Spannung (V)',
        '14.027':'StromstÃ¤rke (A)','14.031':'Frequenz (Hz)','14.033':'WÃ¤rme (J)',
        '14.056':'Wirkleistung (W)','14.057':'Scheinleistung (VA)',
        '14.068':'Temperatur (Â°C)','14.076':'Volumen (mÂ³)',
        '16':'Zeichenkette (14 Byte ASCII)','16.001':'Zeichenkette (ISO 8859-1)',
        '17':'Szenen-Nummer (1â€“64)','18':'Szenen-Aktivierung/Speicherung',
        '19':'Datum und Uhrzeit (8 Byte)',
        '20':'1-Byte AufzÃ¤hlung','20.001':'Systemuhr-Modus','20.002':'Bausystem-Modus',
        '20.102':'HVAC Betriebsart','20.103':'HVAC Steuerung','20.105':'HVAC Zusatz-Betriebsart',
        '21':'8-Bit Statusfeld','22':'16-Bit Statusfeld',
        '29':'8-Byte Signed','29.001':'ImpulszÃ¤hler','29.002':'Pulsdifferenz','29.010':'Wirkenergie (Wh)',
        '232':'RGB-Farbe (3 Byte)','232.600':'RGB (Rot/GrÃ¼n/Blau)',
        '251':'RGBW-Farbe (6 Byte)',
      };
      const subKey = dpt.sub != null ? `${dpt.main}.${String(dpt.sub).padStart(3,'0')}` : null;
      return names[subKey] || names[String(dpt.main)] || (subKey ? `DPT ${subKey}` : `DPT ${dpt.main}`);
    },

    flagTitle(ko) {
      const f = ko.flags ?? {};
      const lines = [];
      if (f.communication) lines.push('C â€“ Kommunikation (Objekt nimmt am Bus teil)');
      if (f.read)          lines.push('R â€“ Lesen (Wert kann abgefragt werden)');
      if (f.write)         lines.push('W â€“ Schreiben (Wert kann gesetzt werden)');
      if (f.transmit)      lines.push('T â€“ Senden (Wert wird bei Ã„nderung gesendet)');
      if (f.update)        lines.push('U â€“ Aktualisieren (Wert wird bei Empfang Ã¼bernommen)');
      if (f.read_on_init)  lines.push('I â€“ Lesen bei Initialisierung');
      return lines.join('\n') || 'Keine Flags gesetzt';
    },

    flagString(ko) {
      const f = ko.flags ?? {};
      const flags = [];
      if (f.read) flags.push('R');
      if (f.write) flags.push('W');
      if (f.transmit) flags.push('T');
      if (f.update) flags.push('U');
      if (f.communication) flags.push('C');
      return flags.join('') || 'â€”';
    },

    deviceCOs(addr) {
      return this.allCOs.filter(co => co._device === addr);
    },

    get cosByDevice() {
      const grouped = {};
      for (const co of this.filteredCOs) {
        if (!grouped[co._device]) grouped[co._device] = [];
        grouped[co._device].push(co);
      }
      return Object.entries(grouped).map(([addr, cos]) => ({
        addr,
        deviceName: this.project?.devices?.[addr]?.name ?? addr,
        cos: cos.sort((a, b) => (a.number ?? 0) - (b.number ?? 0)),
      }));
    },

    renderSpace(space, depth) {
      if (!space) return '';
      const indent = depth * 16;
      const items = Object.values(space.spaces ?? {});
      const fns = space.functions ?? [];
      let html = '';

      for (const child of items) {
        const typeLabel = child.type ? `<span class="text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded mr-2">${child.type}</span>` : '';
        html += `<div class="border-b last:border-b-0">`;
        html += `<div class="flex items-center gap-2 py-2 hover:bg-gray-50" style="padding-left: ${8 + indent}px">`;
        html += `${typeLabel}<span class="text-sm text-gray-700">${child.name ?? ''}</span>`;
        html += `</div>`;
        if (child.spaces && Object.keys(child.spaces).length > 0) {
          html += this.renderSpace(child, depth + 1);
        }
        if (child.functions && child.functions.length > 0) {
          for (const fn of child.functions) {
            const fnData = this.project?.functions?.[fn];
            if (fnData) {
              html += `<div class="py-1 text-xs text-blue-600" style="padding-left: ${8 + indent + 16}px">âš¡ ${fnData.name}</div>`;
            }
          }
        }
        html += `</div>`;
      }

      for (const fnId of fns) {
        const fnData = this.project?.functions?.[fnId];
        if (fnData) {
          html += `<div class="py-1 text-xs text-blue-600 border-b last:border-b-0" style="padding-left: ${8 + indent}px">âš¡ ${fnData.name}</div>`;
        }
      }
      return html;
    },
  };
}
</script>
</body>
</html>
