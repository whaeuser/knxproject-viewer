#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
LOG_DIR="$SCRIPT_DIR/logs"
PID_FILE="$SCRIPT_DIR/.server.pid"
PID_FILE_PUBLIC="$SCRIPT_DIR/.server-public.pid"

_check_venv() {
    if [[ ! -f "$VENV_DIR/bin/uvicorn" ]]; then
        echo "Fehler: Virtuelle Umgebung nicht gefunden. Bitte zuerst 'openknxviewer setup' ausführen."
        exit 1
    fi
}

# ── setup ─────────────────────────────────────────────────────────────────────
cmd_setup() {
    echo "==> Erstelle virtuelles Environment …"
    python3 -m venv "$VENV_DIR"
    echo "==> Installiere Abhängigkeiten …"
    "$VENV_DIR/bin/pip" install --upgrade pip --quiet
    "$VENV_DIR/bin/pip" install -r "$SCRIPT_DIR/requirements.txt" --quiet
    echo ""
    echo "Fertig! Server starten mit:  ./openknxviewer start"
}

# ── start ─────────────────────────────────────────────────────────────────────
cmd_start() {
    _check_venv
    local public=false
    for arg in "$@"; do [[ "$arg" == "--public" ]] && public=true; done
    mkdir -p "$LOG_DIR"

    if $public; then
        if [[ -f "$PID_FILE_PUBLIC" ]] && kill -0 "$(cat "$PID_FILE_PUBLIC")" 2>/dev/null; then
            echo "Öffentlicher Server läuft bereits (PID $(cat "$PID_FILE_PUBLIC"), Port 8004)"
            exit 0
        fi
        cd "$SCRIPT_DIR"
        "$VENV_DIR/bin/uvicorn" server_public:app --host 0.0.0.0 --port 8004 \
            >>"$LOG_DIR/stdout-public.log" 2>>"$LOG_DIR/stderr-public.log" &
        echo $! >"$PID_FILE_PUBLIC"
        echo "Öffentlicher Server gestartet (PID $!, Port 8004)"
    else
        if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
            echo "Privater Server läuft bereits (PID $(cat "$PID_FILE"), Port 8002)"
            exit 0
        fi
        cd "$SCRIPT_DIR"
        "$VENV_DIR/bin/uvicorn" server:app --host 0.0.0.0 --port 8002 \
            >>"$LOG_DIR/stdout.log" 2>>"$LOG_DIR/stderr.log" &
        echo $! >"$PID_FILE"
        echo "Privater Server gestartet (PID $!, Port 8002)"
    fi
}

# ── stop ──────────────────────────────────────────────────────────────────────
_stop_one() {
    local pid_file="$1" label="$2"
    if [[ -f "$pid_file" ]]; then
        local pid
        pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid"
            echo "$label gestoppt (PID $pid)"
        else
            echo "$label war nicht aktiv"
        fi
        rm -f "$pid_file"
    else
        echo "Kein PID-File für $label gefunden"
    fi
}

cmd_stop() {
    local public=false all=false
    for arg in "$@"; do
        [[ "$arg" == "--public" ]] && public=true
        [[ "$arg" == "--all"    ]] && all=true
    done
    if $all; then
        _stop_one "$PID_FILE"        "Privater Server"
        _stop_one "$PID_FILE_PUBLIC" "Öffentlicher Server"
    elif $public; then
        _stop_one "$PID_FILE_PUBLIC" "Öffentlicher Server"
    else
        _stop_one "$PID_FILE" "Privater Server"
    fi
}

# ── status ────────────────────────────────────────────────────────────────────
_status_one() {
    local pid_file="$1" label="$2" port="$3"
    if [[ -f "$pid_file" ]] && kill -0 "$(cat "$pid_file")" 2>/dev/null; then
        printf "%-24s läuft   (PID %s, Port %s)\n" "$label:" "$(cat "$pid_file")" "$port"
        if [[ "$port" == "8002" ]] && command -v curl &>/dev/null; then
            local gw
            gw=$(curl -sf "http://localhost:8002/api/gateway" 2>/dev/null || true)
            if [[ -n "$gw" ]]; then
                python3 - "$gw" <<'EOF'
import json, sys
d = json.loads(sys.argv[1])
ip   = d.get('ip', '?')
port = d.get('port', '?')
ok   = 'verbunden' if d.get('connected') else 'nicht verbunden'
lang = d.get('language', '?')
print(f'  Gateway:               {ip}:{port} — {ok}  [{lang}]')
EOF
            fi
        fi
    else
        printf "%-24s gestoppt\n" "$label:"
    fi
}

cmd_status() {
    _status_one "$PID_FILE"        "Privater Server"     "8002"
    _status_one "$PID_FILE_PUBLIC" "Öffentlicher Server" "8004"
}

# ── logs ──────────────────────────────────────────────────────────────────────
cmd_logs() {
    local lines=50 follow=false
    local args=("$@")
    local i=0
    while [[ $i -lt ${#args[@]} ]]; do
        case "${args[$i]}" in
            --lines|-n) i=$((i+1)); lines="${args[$i]}" ;;
            --follow|-f) follow=true ;;
        esac
        i=$((i+1))
    done
    local log_file="$LOG_DIR/knx_bus.log"
    if [[ ! -f "$log_file" ]]; then
        echo "Keine Logdatei vorhanden: $log_file"
        exit 1
    fi
    if $follow; then
        tail -n "$lines" -f "$log_file"
    else
        tail -n "$lines" "$log_file"
    fi
}

# ── gateway ───────────────────────────────────────────────────────────────────
cmd_gateway() {
    local ip="" port="" lang=""
    local args=("$@")
    local i=0
    while [[ $i -lt ${#args[@]} ]]; do
        case "${args[$i]}" in
            --ip)       i=$((i+1)); ip="${args[$i]}" ;;
            --port)     i=$((i+1)); port="${args[$i]}" ;;
            --language) i=$((i+1)); lang="${args[$i]}" ;;
        esac
        i=$((i+1))
    done

    local cfg="$SCRIPT_DIR/config.json"

    if [[ -z "$ip" && -z "$port" && -z "$lang" ]]; then
        if [[ -f "$cfg" ]]; then
            python3 - "$cfg" <<'EOF'
import json, sys
d = json.load(open(sys.argv[1]))
print(f"IP:       {d.get('gateway_ip','(nicht gesetzt)')}")
print(f"Port:     {d.get('gateway_port', 3671)}")
print(f"Sprache:  {d.get('language', 'de-DE')}")
EOF
        else
            echo "config.json nicht gefunden"
        fi
        return
    fi

    # Server läuft → API verwenden
    if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null && command -v curl &>/dev/null; then
        local current
        current=$(curl -sf http://localhost:8002/api/gateway 2>/dev/null || true)
        if [[ -n "$current" ]]; then
            python3 - "$current" "$ip" "$port" "$lang" <<'EOF'
import json, sys, urllib.request
d    = json.loads(sys.argv[1])
ip   = sys.argv[2] if sys.argv[2] else d['ip']
port = int(sys.argv[3]) if sys.argv[3] else d['port']
lang = sys.argv[4] if sys.argv[4] else d.get('language', 'de-DE')
payload = json.dumps({'ip': ip, 'port': port, 'language': lang}).encode()
req = urllib.request.Request('http://localhost:8002/api/gateway',
    data=payload, headers={'Content-Type': 'application/json'}, method='POST')
urllib.request.urlopen(req)
print(f'Gateway aktualisiert (via API): {ip}:{port}, Sprache: {lang}')
EOF
            return
        fi
    fi

    # Server gestoppt → config.json direkt schreiben
    python3 - "$cfg" "$ip" "$port" "$lang" <<'EOF'
import json, pathlib, sys
p    = pathlib.Path(sys.argv[1])
d    = json.loads(p.read_text()) if p.exists() else {}
ip, port, lang = sys.argv[2], sys.argv[3], sys.argv[4]
if ip:   d['gateway_ip']   = ip
if port: d['gateway_port'] = int(port)
if lang: d['language']     = lang
p.write_text(json.dumps(d, indent=2))
print(f"Gateway gespeichert: {d.get('gateway_ip')}:{d.get('gateway_port')}, Sprache: {d.get('language')}")
EOF
}

# ── autostart (macOS LaunchAgent) ─────────────────────────────────────────────
cmd_autostart() {
    if [[ "$(uname)" != "Darwin" ]]; then
        echo "Autostart wird nur unter macOS unterstützt."
        exit 1
    fi
    local public=false remove=false
    for arg in "$@"; do
        [[ "$arg" == "--public" ]] && public=true
        [[ "$arg" == "--remove" ]] && remove=true
    done

    local label port server stdout stderr
    if $public; then
        label="com.knxproject-viewer-public"
        port=8004; server="server_public:app"
        stdout="stdout-public.log"; stderr="stderr-public.log"
    else
        label="com.knxproject-viewer"
        port=8002; server="server:app"
        stdout="stdout.log"; stderr="stderr.log"
    fi
    local plist="$HOME/Library/LaunchAgents/${label}.plist"

    if $remove; then
        if [[ -f "$plist" ]]; then
            launchctl unload -w "$plist" 2>/dev/null || true
            rm "$plist"
            echo "Autostart entfernt: $plist"
        else
            echo "Kein Autostart gefunden: $plist"
        fi
        return
    fi

    _check_venv
    mkdir -p "$LOG_DIR"
    cat >"$plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>             <string>${label}</string>
    <key>ProgramArguments</key>
    <array>
        <string>${VENV_DIR}/bin/uvicorn</string>
        <string>${server}</string>
        <string>--host</string>  <string>0.0.0.0</string>
        <string>--port</string>  <string>${port}</string>
    </array>
    <key>RunAtLoad</key>         <true/>
    <key>KeepAlive</key>         <true/>
    <key>WorkingDirectory</key>  <string>${SCRIPT_DIR}</string>
    <key>StandardOutPath</key>   <string>${LOG_DIR}/${stdout}</string>
    <key>StandardErrorPath</key> <string>${LOG_DIR}/${stderr}</string>
</dict>
</plist>
EOF
    launchctl unload "$plist" 2>/dev/null || true
    launchctl load -w "$plist"
    echo "Autostart installiert: $plist"
    echo "Server startet bei jedem Login auf Port $port."
    echo "Logs: $LOG_DIR/"
}

# ── update ────────────────────────────────────────────────────────────────────
cmd_update() {
    _check_venv
    echo "==> Aktualisiere Abhängigkeiten …"
    "$VENV_DIR/bin/pip" install --upgrade pip --quiet
    "$VENV_DIR/bin/pip" install --upgrade -r "$SCRIPT_DIR/requirements.txt" --quiet
    echo ""
    echo "Installierte Versionen:"
    "$VENV_DIR/bin/pip" show xknxproject xknx fastapi uvicorn 2>/dev/null \
        | grep -E "^(Name|Version):" | paste - - \
        | awk '{printf "  %-20s %s\n", $2, $4}'
}

# ── usage ─────────────────────────────────────────────────────────────────────
usage() {
    echo "Verwendung: openknxviewer <Befehl> [Optionen]"
    echo ""
    echo "  setup                                  Umgebung erstellen & Pakete installieren"
    echo "  start  [--public]                      Server starten (Standard: Port 8002)"
    echo "  stop   [--public | --all]              Server stoppen"
    echo "  status                                 Server- und Gateway-Status anzeigen"
    echo "  logs   [--lines N] [--follow]          Bus-Log anzeigen"
    echo "  gateway                                Gateway-Konfiguration anzeigen"
    echo "  gateway --ip X [--port Y] [--language L]  Gateway konfigurieren"
    echo "  update                                 Alle Pakete aktualisieren"
    echo "  autostart          [--public]          macOS LaunchAgent installieren"
    echo "  autostart --remove [--public]          macOS LaunchAgent entfernen"
}

# ── dispatch ──────────────────────────────────────────────────────────────────
case "${1:-}" in
    setup)   shift; cmd_setup   "$@" ;;
    start)   shift; cmd_start   "$@" ;;
    stop)    shift; cmd_stop    "$@" ;;
    status)  shift; cmd_status  "$@" ;;
    logs)    shift; cmd_logs    "$@" ;;
    gateway) shift; cmd_gateway "$@" ;;
    update)    shift; cmd_update    "$@" ;;
    autostart) shift; cmd_autostart "$@" ;;
    *)         usage; exit 1 ;;
esac
